var B=Object.create;var h=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var F=e=>h(e,"__esModule",{value:!0});var _=(e,t,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of P(t))!K.call(e,n)&&n!=="default"&&h(e,n,{get:()=>t[n],enumerable:!(a=U(t,n))||a.enumerable});return e},l=e=>_(F(h(e!=null?B(N(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var j=require("crypto"),M=require("fs"),g={computeHash:function(e){return j.createHash("sha256").update(e).digest("base64")},generateUID:function(e){return"xxxxxxxx-xxxx-4xxxx-xxx-x".replace(/[xy]/g,function(t){var a=Math.random()*16|0,n=t=="x"?a:a&3|8;return n.toString(16)})},filter:function(e,t,a){if(!t.originalname.match(/\.(jpg|JPG|jpeg|JPEG|png|PNG|jfif|JFIF|webm|WEBM)$/))return e.fileValidationError="Only image files are allowed",a(new Error("Only image files are allowed"),!1);a(null,!0)},getExt:function(e){var t=e.lastIndexOf(".");return t<0?"":e.substr(t)},replaceValues:function(e,t){var e=e.replace(/\[\w*\]/g,function(a,n){return t[a.slice(1,-1)]||a});return e},getFileStream:async function(e){let t=M.createReadStream(e);return await new Promise(function(r,o){t.on("data",c=>r(c.toString())),t.on("error",o)})}};var A=l(require("dotenv"));var m=l(require("sqlite3"));m.default.verbose();var f=class{constructor(t){this._db=new m.default.Database(t),this._db.run("PRAGMA journal_mode = WAL")}run(t,...a){return new Promise((n,r)=>{this._db.run(t,...a,function(o){o?r(o):n(this)})})}get(t,...a){return new Promise((n,r)=>{this._db.get(t,...a,(o,c)=>{o?r(o):n(c)})})}all(t,...a){return new Promise((n,r)=>{this._db.all(t,...a,(o,c)=>{o?r(o):n(c)})})}exec(t,...a){return new Promise((n,r)=>{this._db.exec(t,o=>{o?r(o):n(this)})})}};var w=9e5,E=class{constructor(){this._cache={}}all(){return this._cache}get(t,a,n=w){let r=this._cache[t];return r==null&&(r=a(),this.set(t,r,n)),r}async getAsync(t,a,n=w){let r=this._cache[t];return r==null&&(r=a(),this.set(t,r,n)),r}set(t,a,n=w){this._cache[t]=a,setTimeout(()=>{this.del(t)},n)}del(t){delete this._cache[t]}flush(){this._cache={}}exists(t){return this._cache[t]!=null}};var y=l(require("express")),I=l(require("cookie-parser")),d=l(require("firebase-admin"));var O="service_account",H="partyshare-47d15",G="e25d712d9968cb22e26c6e479eab353491fd2f44",V=`-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCrEnS10v+DHpno
sbEby4fWlgcjUNFhLkdy+MC/0tEL4lQSIwxVePFWL0ZBpwb+trfnZ7fn2khe9DAx
13bFHVMhKR2Lbgny0e/Ea97NRRmutGdBA33KSKEYjRR4MfGfe3/Cgu6K4dGf8+Lc
sKQ8LByA64UbmnKyDDM2DLG2WtH3+uJ8ALdpDbA2w0NQ3pi3YDdI207EZFJOJVpD
CE/L8qSkqjyP8VWAUstj3H+B2j/Ea5zH8RKtQIzPrwBewdn8PJU1QuKuN700anXh
VqzUJwzEjQamMrx+38h8Q6XBxUw357bUuC389JCiquM0VCnbVfdyEwmD+0eUZ3nl
Ku4MdRRfAgMBAAECggEACCACRw3UcOfSgN4fqVBLYq0RfbiS7pNXdWXMfHqIzzsF
VISG9hrzwMInYMA2xtZAJHolSUUcIYEQ4O0jiPfRlkZGTvRU/fbBSopNCgwkIiC+
CV/JvlfLaZ0ZwckCztj7bRjxjMsY57NFAnJT+pT7GEHCEAOP5augAGCDTZlBVmO8
zjPrHQIBrJDaArbylayhb29XoW25oMsaDGOp1Hlx2Fq3wK7txtgIaD7wSlZtsQB6
FUFB03+kiY9TNTpwp1cbxriTtRgu9RKvyQ0Rvk0TGyUdc0brrHnq2U4ot1VJFj1e
n1WT9iHR4Ovx1qC3Al8MPnBrZ+PraVmN5T0CawdsEQKBgQDipCVTBv0OpkS1E8XI
f+KviQueU893NZUruLJAkHFMJYu6dn//pIxGRw4chVwmWIuS2ZhHsztjW2giznEO
92WE8oFAneb9THQDbVwFfOfuY4GdEULoUrNLhFKK1dfise2GVmp3UgQhENcSwoZR
/Z6s9yaDXNK75taVR055SNObLQKBgQDBO4hhnsduoqeTX52dHn9psnqBfzgbUFHh
fdvTdOqzv++6yaoL22hGQTZMuul0Gg4ryHV9VJZ1L0/1epO/9hxGxom58RJLWCxw
SAuH3ZEjS7KYGZgh+IDDGtcdNhykENLOPEWoG1uukBZerjxa3+eLmvHa8vYMzqiW
MySV4NA1OwKBgQDNJt5uUIYii5jn/DTtL+3HDRuKPr0uYD9eKzqXPOiBj/7yUy+7
/XvIZas9X+4w+7ejvvmb9X6NioEx+ILYlFK9zDH5hrU/lcPyEjzY7t6WqFX8ElLp
L2sCsY1yBO39Uyf5kSGgTopUUAUPAyxI7XWDhdjD0fMjiWm2CKzdFnINJQKBgBL9
r9ywRzd3YvLX/dyYR7tyoBmkEDaXAUUhIn64yexam8wGz+CUcr4c4KJP6GvRt7zT
2cA0lQj1Wm1s26KNJKBMGPMeX0bqZouuePukagRHB0ltkoccLkN+ms+zJsN1J9K/
F7V64trYLGqnwyTHRrFwy/5RzJ7bnLQOWLUmQDBLAoGBALPU5afAQEacP1C8KbVM
J9yDEFpHudwgC8c6MnCK0IIpaS4IA+r8f74q/QswyeANyYX9FggdAp+SM1aDOAcQ
fY0+gOptWoB7NuGfk/rhs6ezo8ivLtXWDKzA44DS0K9NNcf1a+ysP6I0mVws5mA8
QEoYzPmkP+BNjhnXqBg5ykMx
-----END PRIVATE KEY-----
`,Q="firebase-adminsdk-dx0dk@partyshare-47d15.iam.gserviceaccount.com",W="115450043492170133553",Y="https://accounts.google.com/o/oauth2/auth",z="https://oauth2.googleapis.com/token",J="https://www.googleapis.com/oauth2/v1/certs",X="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-dx0dk%40partyshare-47d15.iam.gserviceaccount.com",x={type:O,project_id:H,private_key_id:G,private_key:V,client_email:Q,client_id:W,auth_uri:Y,token_uri:z,auth_provider_x509_cert_url:J,client_x509_cert_url:X};var S=l(require("stripe")),D=l(require("sharp")),b=l(require("multer"));A.default.config();var v="http://partyshare.ca",u=new f("database/partyshare.db");async function Z(){u.exec("CREATE TABLE IF NOT EXISTS accounts ( id varchar(25) PRIMARY KEY, name varchar(100), email varchar(80), authID varchar(28), location varchar(250) ) "),u.exec("CREATE TABLE IF NOT EXISTS products ( name varchar(75), id varchar(25), accountID varchar(25), imageURL varchar(55), category varchar(12), desc varchar(250), info varchar(200), quantity int, price int )")}Z();var p=new E,s=(0,y.default)();s.use(y.default.json());s.use(y.default.urlencoded({extended:!0}));s.use((0,I.default)());s.set("view engine","ejs");s.use("/views",y.default.static("views"));d.default.initializeApp({credential:d.default.credential.cert(x),storageBucket:process.env.BUCKET_URL});var k=d.default.firestore();s.locals.bucket=d.default.storage().bucket();var R=new S.default(process.env.STRIPE_KEY,{apiVersion:"2020-08-27"}),q=(0,b.default)({storage:b.default.memoryStorage(),fileFilter:g.filter});async function L(e,t,a){let n=60*60*24*t*1e3,r=await d.default.auth().createSessionCookie(e,{expiresIn:n}),o={maxAge:n};a.cookie("session",r,o)}async function C(e){return(await d.default.auth().verifySessionCookie(e||"").catch(()=>null)).uid||null}async function T(e){return await p.getAsync(e,async()=>await u.get("SELECT * FROM accounts WHERE AuthId = ?",e))}s.get("/",async(e,t)=>{let a=await p.getAsync("explore",async()=>await u.all("SELECT id, name, imageURL, price FROM products"));t.render("main/index",{acc:e.cookies.session,products:a})});s.get("/search",async(e,t)=>{let a=await u.all("SELECT id, name, imageURL, price FROM products WHERE name LIKE ? AND category LIKE ?",`%${e.query.query}%`,`%${e.query.category||""}%`);t.render("main/index",{acc:e.cookies.session,products:a})});s.get("/products/:id",async(e,t)=>{let a=await p.getAsync(`fire-${e.params.id}`,async()=>(await k.collection("products").doc(e.params.id).get()).data(),12096e5),n=await p.getAsync(e.params.id,async()=>await u.get("SELECT * FROM products WHERE id = ?",e.params.id)),r=await p.getAsync(n.accountID,async()=>await u.get("SELECT * FROM accounts WHERE id = ?",n.accountID));t.render("products/index",{product:n,account:r,dates:a,acc:e.cookies.session})});s.get("/faq",async(e,t)=>{t.render("faq/index",{acc:e.cookies.session,faqs:[{title:"How do I start renting on PartyShare?",text:"You can contact me at janakhosa@gmail.com to get in touch, and we can help you set up your account!"},{title:"Will I get my deposit back?",text:"Yes! It does take 5 to 10 business days for it to actually show up in your account, so you may not see it right away."},{title:"What information does PartyShare store about me?",text:"PartyShare only stores your email address and nothing else! This is just to contact you about your order, and give you updates on it."}]})});s.get("/vendor-login",async(e,t)=>{t.render("vendor-login/index",{acc:e.cookies.session})});s.get("/add/product",async(e,t)=>{let a=await C(e.cookies.session);a==null&&t.redirect("/");let n=await T(a);t.render("add/index",{name:n.name})});s.get("/accounts/create",async(e,t)=>{let a=g.computeHash(Math.random().toString()).replace("/","|"),n=await R.accounts.create({type:"express",country:"CA",business_type:"individual"}),r=await R.accountLinks.create({account:n.id,refresh_url:`${v}/accounts/create`,return_url:`${v}/accounts/create/${a}`,type:"account_onboarding"});t.cookie("stripeID",n.id),t.redirect(r.url)});s.get("/accounts/create/:hash",async(e,t)=>{t.render("create-account/index")});s.post("/accounts/login",async(e,t)=>{let a=e.body.idToken,n=(await d.default.auth().verifyIdToken(a)).uid;await L(a,14,t),t.end(JSON.stringify({status:"success"}))});s.post("/accounts/create",async(e,t)=>{let a=e.body.idToken,n=(await d.default.auth().verifyIdToken(a)).uid;await L(a,14,t);let r={id:e.cookies.stripeID,name:e.body.name,email:e.body.email,authID:n,location:e.body.location};await u.run("INSERT INTO accounts VALUES (?, ?, ?, ?, ?);",...Object.values(r)),t.clearCookie("stripeID"),t.end(JSON.stringify({status:"completed"}))});s.post("/products/create",q.single("image"),async(e,t)=>{let a=await C(e.cookies.session);a==null&&t.redirect("/");let n=await T(a),r=`${g.computeHash(e.file.originalname+Math.random()).replace(/\//g,"|")}.jpeg`,o=await(0,D.default)(e.file.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();await s.locals.bucket.file(r).createWriteStream().end(o);let c=g.generateUID();await u.run("INSERT INTO products VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",e.body["desktop-name"]||e.body["mobile-name"],c,n.id,r,e.body.category,e.body.desc,e.body.info,parseInt(e.body.quantity),parseInt(e.body.price.substring(1))*100),p.del("explore"),await k.collection("products").doc(c).set({"1263310860":1}),p.set(`fire-${c}`,{"1263310860":1}),t.json({message:"Product successfully added."})});s.get("/logout",async(e,t)=>{t.clearCookie("session"),t.redirect("/")});s.listen(80,()=>{console.log("Server running..."),console.log("")});
//# sourceMappingURL=index.js.map
