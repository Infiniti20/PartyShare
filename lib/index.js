var j=Object.create;var b=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var U=e=>b(e,"__esModule",{value:!0});var N=(e,t,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of X(t))!K.call(e,n)&&n!=="default"&&b(e,n,{get:()=>t[n],enumerable:!(a=_(t,n))||a.enumerable});return e},l=e=>N(U(b(e!=null?j(B(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var V=require("crypto"),W=require("fs"),m={computeHash:function(e){return V.createHash("sha256").update(e).digest("base64")},generateUID:function(e){return"xxxxxxxx-xxxx-4xxxx-xxx-x".replace(/[xy]/g,function(t){var a=Math.random()*16|0,n=t=="x"?a:a&3|8;return n.toString(16)})},filter:function(e,t,a){if(!t.originalname.match(/\.(jpg|JPG|jpeg|JPEG|png|PNG|jfif|JFIF|webm|WEBM)$/))return e.fileValidationError="Only image files are allowed",a(new Error("Only image files are allowed"),!1);a(null,!0)},getExt:function(e){var t=e.lastIndexOf(".");return t<0?"":e.substr(t)},replaceValues:function(e,t){var e=e.replace(/\[\w*\]/g,function(a,n){return t[a.slice(1,-1)]||a});return e},getFileStream:async function(e){let t=W.createReadStream(e);return await new Promise(function(r,s){t.on("data",c=>r(c.toString())),t.on("error",s)})}};var R=l(require("dotenv"));var x=l(require("sqlite3"));x.default.verbose();var k=class{constructor(t){this._db=new x.default.Database(t),this._db.run("PRAGMA journal_mode = WAL")}run(t,...a){return new Promise((n,r)=>{this._db.run(t,...a,function(s){s?r(s):n(this)})})}get(t,...a){return new Promise((n,r)=>{this._db.get(t,...a,(s,c)=>{s?r(s):n(c)})})}all(t,...a){return new Promise((n,r)=>{this._db.all(t,...a,(s,c)=>{s?r(s):n(c)})})}exec(t,...a){return new Promise((n,r)=>{this._db.exec(t,s=>{s?r(s):n(this)})})}};var I=9e5,v=class{constructor(){this._cache={}}all(){return this._cache}get(t,a,n=I){let r=this._cache[t];return r==null&&(r=a(),this.set(t,r,n)),r}async getAsync(t,a,n=I){let r=this._cache[t];return r==null&&(r=a(),this.set(t,r,n)),r}set(t,a,n=I){this._cache[t]=a,setTimeout(()=>{this.del(t)},n)}del(t){delete this._cache[t]}flush(){this._cache={}}exists(t){return this._cache[t]!=null}};var g=l(require("express")),D=l(require("cookie-parser")),p=l(require("firebase-admin"));var Y="service_account",Z="partyshare-2e5c5",J="17d43935ff3b365af79d6a2652720e1559542fd0",G=`-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCtRy0C30BKjPeD
ahOH47mX+ftpvGldoh2U82zkQrL8lx8/vSLLMX6KCrVd7xmXktJz90VtBXBEbEl/
I9N4HEKbZrGKjkxsalsoyebJOWe0v5CwF3xE/ngZTAFYpJOzQpeLpkU6Pa3DenSR
J0PgCBI0vUWhioXZ4ozj7lNY3aUdTGf5TFCiNEewWRxQ19vgejFahU859Vc5s0Y5
b59LrsSfRdxFmDtEoxrMBpZIbJKxGX5Eslxp7b1l8jwOOLXgEcQmXOYfEF69PCjA
g/ow8AmtT6TZJKFeBiZrBFTRHK/TMPMIDeMkkm27p4s3tajvTcfFVfRT0xPfm+dJ
KrO4QXqJAgMBAAECgf8b4cO2kpjC2pS/GVs/izO3zzkFR6v+IiZ3sUsLkqRXetbP
UJzi1UtEWakhDn4M0WHL2KmtZCnpktSSL0X30KuVoYUBbF582U7XpzDy5HtCxfki
LhmfgHXM+VmPj71XaX+5JIUn6ITWFVtVIuf0uPqpWRzSe8Bw6R2Z4Q4OGMq14zF3
kjxM+R/Lssmry5ln72wpuYvppWdNthHyKTH8mtfO/WJhTGSOU1VbZdS1JiyGUIwe
b+tdBQdHqBvpoy0EXyXJ9nwVClM5PYFPC+MWTaAhmM52uAenMqGAKRTLfflb4phX
VJCZfqRgC6v+I0JxjHRZhHiIjEzV8vV2xcH2QXECgYEA5ojatohjTPqj5l8bhUrn
rvtEWYRxBxhT7rIhaFdNA7Xa+XZUMwRxOK7BHwfXmOgHbEPaWH6Yy/neub7DBh5m
ivAuZOfQt+y+iYi/mY9ydVtmX5PUMiHgXv2/uh55luOWirxM2MLZbc3IskmlhpIo
DtaohzEFQZXeqiCTBrW1YpkCgYEAwGsy1QSIouG/bSIo05pfPr4Zl9jmsyu/LrjJ
jxb0/xoOF6p3g4qdNTr6bcUMoxz36ro/qRHGd6WKfSXi4ZKfZSDfwdYhggFOpng0
t+95Srd+dJAVycoXuefkHz9sP6TX695U8IvdxjF9GT02L0bSmZKxFYhhZNeM8JTU
KYpWvXECgYEAotSzNw5qpSq7rbIrrCBWOL/9bQUhGJPUZNqowhw3p5FBk8ZCfq56
kkDM43AUlkn9RDlA9hSlNB3PdX8KHT5Hy4cOHfOm9uJfSqGuQ3aQr9fZHVU7IhXP
dwjf7UQtOaiS4ndSCCDIlsgtI9Dk+4IsjR6Ndr/nKIYE+kF719dswLECgYEAp0KH
xTNTsoKZa7wt0QJ3mIqWpLAemdCFN4/ZZVCHVtjHNzsu+GEdlo/V8GVBPuiHeLq9
a7HP22FCqNauCXbyp22UE2KXbfLE81+6M8kungwzGA/HYMkTJr60RZVT+17Hcnip
TQ/Hj+ik3bOfzii6GFSzKgyK3KWiFd7JLfLaw4ECgYA8bO+c6YFkp0c3t3GF49nb
wg2lbMEyTGoqBj6HIM/wRg5pvJYzSERxItZs3B+KDrlv0HzTZXpmD5DDzacwMX2h
hRe+9Ne8XiQNcHV3O3rVhI9J2rb5eZybImWaweMBVNdVQCvNr+I207yNadrwa8qr
F2ocPFE4W85jPP71Hf8kNQ==
-----END PRIVATE KEY-----
`,z="firebase-adminsdk-77bd3@partyshare-2e5c5.iam.gserviceaccount.com",Q="113520744972971826056",q="https://accounts.google.com/o/oauth2/auth",$="https://oauth2.googleapis.com/token",ee="https://www.googleapis.com/oauth2/v1/certs",te="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-77bd3%40partyshare-2e5c5.iam.gserviceaccount.com",C={type:Y,project_id:Z,private_key_id:J,private_key:G,client_email:z,client_id:Q,auth_uri:q,token_uri:$,auth_provider_x509_cert_url:ee,client_x509_cert_url:te};var F=l(require("stripe")),H=l(require("sharp")),A=l(require("multer")),M=l(require("source-map-support"));R.default.config();var S="http://partyshare.ca",d=new k("database/partyshare.db");async function ae(){d.exec("CREATE TABLE IF NOT EXISTS accounts ( id varchar(25) PRIMARY KEY, name varchar(100), email varchar(80), authID varchar(28), location varchar(250) ) "),d.exec("CREATE TABLE IF NOT EXISTS products ( name varchar(75), id varchar(25), accountID varchar(25), imageURL varchar(55), category varchar(12), desc varchar(250), info varchar(200), quantity int, price int )")}ae();var i=new v,o=(0,g.default)();o.use(g.default.json());o.use(g.default.urlencoded({extended:!0}));o.use((0,D.default)());o.set("view engine","ejs");o.use("/views",g.default.static("views"));p.default.initializeApp({credential:p.default.credential.cert(C),storageBucket:process.env.BUCKET_URL});var T=p.default.firestore();o.locals.bucket=p.default.storage().bucket();var h=new F.default(process.env.STRIPE_KEY,{apiVersion:"2020-08-27"}),ne=(0,A.default)({storage:A.default.memoryStorage(),fileFilter:m.filter});M.default.install();async function P(e,t,a){let n=60*60*24*t*1e3,r=await p.default.auth().createSessionCookie(e,{expiresIn:n}),s={maxAge:n};a.cookie("session",r,s)}async function L(e){return(await p.default.auth().verifySessionCookie(e||"").catch(()=>null)).uid||null}async function O(e){return await i.getAsync(e,async()=>await d.get("SELECT * FROM accounts WHERE authID = ?",e))}o.get("/",async(e,t)=>{let a=await i.getAsync("explore",async()=>await d.all("SELECT id, name, imageURL, price FROM products"));t.render("main/index",{acc:e.cookies.session,products:a})});o.get("/search",async(e,t)=>{let a=await d.all("SELECT id, name, imageURL, price FROM products WHERE name LIKE ? AND category LIKE ?",`%${e.query.query}%`,`%${e.query.category||""}%`);t.render("main/index",{acc:e.cookies.session,products:a})});o.get("/product/:id",async(e,t)=>{let a=await i.getAsync(`fire-${e.params.id}`,async()=>(await T.collection("products").doc(e.params.id).get()).data(),12096e5),n=await i.getAsync(e.params.id,async()=>await d.get("SELECT * FROM products WHERE id = ?",e.params.id)),r=await i.getAsync(n.accountID,async()=>await d.get("SELECT * FROM accounts WHERE id = ?",n.accountID));t.render("products/index",{product:n,account:r,dates:a,acc:e.cookies.session})});o.get("/faq",async(e,t)=>{t.render("faq/index",{acc:e.cookies.session,faqs:[{title:"How do I start renting on PartyShare?",text:"You can contact me at janakhosa@gmail.com to get in touch, and we can help you set up your account!"},{title:"What information does PartyShare store about me?",text:"PartyShare only stores your email address and nothing else! This is just to contact you about your order, and give you updates on it."}]})});o.get("/vendor-login",async(e,t)=>{t.render("vendor-login/index",{acc:e.cookies.session})});o.get("/products/create",async(e,t)=>{let a=await L(e.cookies.session);a==null&&t.redirect("/");let n=await O(a);t.render("add/index",{name:n.name})});o.get("/checkout",(e,t)=>{try{if(!e.cookies.customerID){t.redirect("/");return}let{secret:a,product:n,info:r}=i.get(`tempcache-${e.cookies.customerID}`,()=>{});if(!n){t.redirect("/");return}t.render("checkout/index",{secret:a,product:n,info:r,acc:e.cookies.session})}catch{t.redirect("/")}});o.get("/accounts/create",async(e,t)=>{let a=m.computeHash(Math.random().toString()).replace("/","|"),n=await h.accounts.create({type:"express",country:"CA",business_type:"individual"});console.log(`${S}/accounts/create`);let r=await h.accountLinks.create({account:n.id,refresh_url:`${S}/accounts/create/`,return_url:`${S}/accounts/create/${a}`,type:"account_onboarding"});t.cookie("stripeID",n.id),t.redirect(r.url)});o.get("/accounts/create/:hash",async(e,t)=>{t.render("create-account/index")});o.post("/accounts/login",async(e,t)=>{console.log(e.body);let a=e.body.idToken;await P(a,14,t),t.end(JSON.stringify({status:"success"}))});o.post("/accounts/create",async(e,t)=>{let a=e.body.idToken,n=(await p.default.auth().verifyIdToken(a)).uid;await P(a,14,t);let r={id:e.cookies.stripeID,name:e.body.name,email:e.body.email,authID:n,location:e.body.location};await d.run("INSERT INTO accounts VALUES (?, ?, ?, ?, ?);",...Object.values(r)),t.clearCookie("stripeID"),t.end(JSON.stringify({status:"completed"}))});o.post("/products/create",ne.single("image"),async(e,t)=>{let a=await L(e.cookies.session);a==null&&t.redirect("/");let n=await O(a),r=`${m.computeHash(e.file.originalname+Math.random()).replace(/\//g,"|")}.jpeg`,s=await(0,H.default)(e.file.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();await o.locals.bucket.file(r).createWriteStream().end(s);let c=m.generateUID();await d.run("INSERT INTO products VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",e.body["desktop-name"]||e.body["mobile-name"],c,n.id,r,e.body.category,e.body.desc,e.body.info,parseInt(e.body.quantity),parseInt(e.body.price.substring(1))*100),i.del("explore"),await T.collection("products").doc(c).set({"1263310860":1}),i.set(`fire-${c}`,{"1263310860":1}),t.json({status:"200 OK",message:"Product successfully added."})});o.post("/orders/create",async(e,t)=>{let a=e.cookies.customerID,r=(await h.paymentMethods.list({customer:a,type:"card"})).data[0].id,{secret:s,product:c,info:f}=i.get(`tempcache-${a}`,()=>{});i.del(`tempcache-${a}`);let E=await i.getAsync(c.accountID,async()=>await d.get("SELECT * FROM accounts WHERE id = ?",c.accountID)),y=await i.getAsync(`fire-${c.id}`,async()=>(await T.collection("products").doc(c.id).get()).data());console.log(y)});o.post("/checkout",async(e,t)=>{let a=await h.customers.create(),n=await h.setupIntents.create({customer:a.id}),r=i.set(a.id,{name:"",id:a.id,email:""},18e6);t.cookie("customerID",a.id);let{startDate:s,endDate:c,quantity:f,productID:E}=e.body,y=Math.max(s-c,1),w=await i.getAsync(E,async()=>await d.get("SELECT * FROM products WHERE id = ?",E)),re=w.price*f*y;i.set(`tempcache-${a.id}`,{secret:n.client_secret,product:w,info:{quantity:f,daysRented:y}},36e5),t.json({status:"200 OK",message:"Checkout page ready."})});o.get("/logout",async(e,t)=>{t.clearCookie("session"),t.redirect("/")});o.get("");o.listen(80,()=>{console.log("Server running..."),console.log("")});
//# sourceMappingURL=index.js.map
