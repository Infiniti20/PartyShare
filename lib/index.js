var q=Object.create;var A=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var ae=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var se=e=>A(e,"__esModule",{value:!0});var oe=(e,t,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of te(t))!ne.call(e,n)&&n!=="default"&&A(e,n,{get:()=>t[n],enumerable:!(a=ee(t,n))||a.enumerable});return e},m=e=>oe(se(A(e!=null?q(ae(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var H=m(require("crypto")),P=m(require("fs")),j=m(require("nodemailer")),U=m(require("dotenv"));U.default.config();var ie=j.default.createTransport({service:"gmail",auth:{user:process.env.EMAIL,pass:process.env.PASSWORD}}),y={computeHash:function(e){return H.default.createHash("sha256").update(e).digest("base64")},generateUID:function(e){return"xxxxxxxx-xxxx-4xxxx-xxx-x".replace(/[xy]/g,function(t){var a=Math.random()*16|0,n=t=="x"?a:a&3|8;return n.toString(16)})},filter:function(e,t,a){if(!t.originalname.match(/\.(jpg|JPG|jpeg|JPEG|png|PNG|jfif|JFIF|webm|WEBM)$/))return e.fileValidationError="Only image files are allowed",a(new Error("Only image files are allowed"),!1);a(null,!0)},getExt:function(e){var t=e.lastIndexOf(".");return t<0?"":e.substr(t)},replaceValues:function(e,t){var e=e.replace(/\[\w*\]/g,function(a,n){return t[a.slice(1,-1)]||a});return e},getFileStream:async function(e){let t=P.default.createReadStream(e);return await new Promise(function(s,o){t.on("data",i=>s(i.toString())),t.on("error",o)})},sendMail:async function(e,t,a,n){let s=await this.getFileStream(a),o={from:process.env.EMAIL,to:e,subject:t,html:this.replaceValues(s,n)};ie.sendMail(o,function(i,d){i&&console.log(i)})}};var N=m(require("dotenv"));var T=m(require("sqlite3"));T.default.verbose();var R=class{constructor(t){this._db=new T.default.Database(t),this._db.run("PRAGMA journal_mode = WAL")}run(t,...a){return new Promise((n,s)=>{this._db.run(t,...a,function(o){o?s(o):n(this)})})}get(t,...a){return new Promise((n,s)=>{this._db.get(t,...a,(o,i)=>{o?s(o):n(i)})})}all(t,...a){return new Promise((n,s)=>{this._db.all(t,...a,(o,i)=>{o?s(o):n(i)})})}exec(t,...a){return new Promise((n,s)=>{this._db.exec(t,o=>{o?s(o):n(this)})})}};var S=9e5,v=class{constructor(){this._cache={}}all(){return this._cache}get(t,a,n=S){let s=this._cache[t];return s===void 0&&(s=a(),this.set(t,s,n)),s}async getAsync(t,a,n=S){let s=this._cache[t];return s===void 0&&(s=a(),this.set(t,s,n)),s}set(t,a,n=S){this._cache[t]=a,setTimeout(()=>{this.del(t)},n)}del(t){delete this._cache[t]}flush(){this._cache={}}exists(t){return this._cache[t]!==void 0}};var I=m(require("express")),V=m(require("cookie-parser")),h=m(require("firebase-admin"));var ce="service_account",re="partyshare-2e5c5",de="17d43935ff3b365af79d6a2652720e1559542fd0",ue=`-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCtRy0C30BKjPeD
ahOH47mX+ftpvGldoh2U82zkQrL8lx8/vSLLMX6KCrVd7xmXktJz90VtBXBEbEl/
I9N4HEKbZrGKjkxsalsoyebJOWe0v5CwF3xE/ngZTAFYpJOzQpeLpkU6Pa3DenSR
J0PgCBI0vUWhioXZ4ozj7lNY3aUdTGf5TFCiNEewWRxQ19vgejFahU859Vc5s0Y5
b59LrsSfRdxFmDtEoxrMBpZIbJKxGX5Eslxp7b1l8jwOOLXgEcQmXOYfEF69PCjA
g/ow8AmtT6TZJKFeBiZrBFTRHK/TMPMIDeMkkm27p4s3tajvTcfFVfRT0xPfm+dJ
KrO4QXqJAgMBAAECgf8b4cO2kpjC2pS/GVs/izO3zzkFR6v+IiZ3sUsLkqRXetbP
UJzi1UtEWakhDn4M0WHL2KmtZCnpktSSL0X30KuVoYUBbF582U7XpzDy5HtCxfki
LhmfgHXM+VmPj71XaX+5JIUn6ITWFVtVIuf0uPqpWRzSe8Bw6R2Z4Q4OGMq14zF3
kjxM+R/Lssmry5ln72wpuYvppWdNthHyKTH8mtfO/WJhTGSOU1VbZdS1JiyGUIwe
b+tdBQdHqBvpoy0EXyXJ9nwVClM5PYFPC+MWTaAhmM52uAenMqGAKRTLfflb4phX
VJCZfqRgC6v+I0JxjHRZhHiIjEzV8vV2xcH2QXECgYEA5ojatohjTPqj5l8bhUrn
rvtEWYRxBxhT7rIhaFdNA7Xa+XZUMwRxOK7BHwfXmOgHbEPaWH6Yy/neub7DBh5m
ivAuZOfQt+y+iYi/mY9ydVtmX5PUMiHgXv2/uh55luOWirxM2MLZbc3IskmlhpIo
DtaohzEFQZXeqiCTBrW1YpkCgYEAwGsy1QSIouG/bSIo05pfPr4Zl9jmsyu/LrjJ
jxb0/xoOF6p3g4qdNTr6bcUMoxz36ro/qRHGd6WKfSXi4ZKfZSDfwdYhggFOpng0
t+95Srd+dJAVycoXuefkHz9sP6TX695U8IvdxjF9GT02L0bSmZKxFYhhZNeM8JTU
KYpWvXECgYEAotSzNw5qpSq7rbIrrCBWOL/9bQUhGJPUZNqowhw3p5FBk8ZCfq56
kkDM43AUlkn9RDlA9hSlNB3PdX8KHT5Hy4cOHfOm9uJfSqGuQ3aQr9fZHVU7IhXP
dwjf7UQtOaiS4ndSCCDIlsgtI9Dk+4IsjR6Ndr/nKIYE+kF719dswLECgYEAp0KH
xTNTsoKZa7wt0QJ3mIqWpLAemdCFN4/ZZVCHVtjHNzsu+GEdlo/V8GVBPuiHeLq9
a7HP22FCqNauCXbyp22UE2KXbfLE81+6M8kungwzGA/HYMkTJr60RZVT+17Hcnip
TQ/Hj+ik3bOfzii6GFSzKgyK3KWiFd7JLfLaw4ECgYA8bO+c6YFkp0c3t3GF49nb
wg2lbMEyTGoqBj6HIM/wRg5pvJYzSERxItZs3B+KDrlv0HzTZXpmD5DDzacwMX2h
hRe+9Ne8XiQNcHV3O3rVhI9J2rb5eZybImWaweMBVNdVQCvNr+I207yNadrwa8qr
F2ocPFE4W85jPP71Hf8kNQ==
-----END PRIVATE KEY-----
`,le="firebase-adminsdk-77bd3@partyshare-2e5c5.iam.gserviceaccount.com",me="113520744972971826056",pe="https://accounts.google.com/o/oauth2/auth",ge="https://oauth2.googleapis.com/token",ye="https://www.googleapis.com/oauth2/v1/certs",fe="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-77bd3%40partyshare-2e5c5.iam.gserviceaccount.com",_={type:ce,project_id:re,private_key_id:de,private_key:ue,client_email:le,client_id:me,auth_uri:pe,token_uri:ge,auth_provider_x509_cert_url:ye,client_x509_cert_url:fe};var Z=m(require("stripe")),C=m(require("sharp")),L=m(require("multer"));var x=864e5;function he(e,t){let a=[],n=e;if(t===e)return[e];for(t-=x;n!==t;)n+=x,a.push(n);return[e,...a,t+=x]}function O(e,t,a,n,s){let d=Object.keys(e).filter(l=>parseInt(l)>=t&&parseInt(l)<=a).map(l=>e[l.toString()]),p=he(t,a);if(d.some(l=>l-n>0)||d.length<1){for(let f of p)e[f]?e[f]-=n:e[f]=s-n;let l=a+x;return e[l]?e[l]+=n:e[l]=s,e}}var z=m(require("source-map-support"));var W=m(require("long-timeout")),w={};function J(e,t){return w[e]=t,t}function K(e){return w.edit=e,e}function M(e,t,a){console.log(w);let n=Ee(a);console.log(n),W.default.setTimeout(()=>{console.log("executed"),e(...t)},n)}function Ee(e){let t=e.getTime(),a=new Date().getTime();return Math.max(t-a,0)}async function B(e){let t=new Date().getTime(),a=Object.keys(e),n=Object.values(e);for(let s=0;s<n.length;s++){let o=n[s];if(console.log(t,o.date),t>o.date){o.passed==!1&&(w[o.name](...o.args),await w.edit(a[s]));continue}M(w[o.name],o.args,new Date(o.date))}}N.default.config();var X="http://partyshare.ca",u=new R("database/partyshare.db");async function we(){await u.exec("CREATE TABLE IF NOT EXISTS accounts ( id varchar(25) PRIMARY KEY, name varchar(100), email varchar(80), authID varchar(28), location varchar(250) ) "),await u.exec("CREATE TABLE IF NOT EXISTS products ( name varchar(75), id varchar(25), accountID varchar(25), imageURL varchar(55), category varchar(12), desc varchar(250), info varchar(200), quantity int, price int )")}we();var c=new v,r=(0,I.default)();r.use(I.default.json());r.use(I.default.urlencoded({extended:!0}));r.use((0,V.default)());r.set("view engine","ejs");r.use("/views",I.default.static("views"));h.default.initializeApp({credential:h.default.credential.cert(_),storageBucket:process.env.BUCKET_URL});var E=h.default.firestore(),Y=h.default.storage().bucket(),b=new Z.default(process.env.STRIPE_KEY,{apiVersion:"2020-08-27"}),G=(0,L.default)({storage:L.default.memoryStorage(),fileFilter:y.filter});z.default.install();async function Q(e,t,a){let n=60*60*24*t*1e3,s=await h.default.auth().createSessionCookie(e,{expiresIn:n}),o={maxAge:n};a.cookie("session",s,o)}async function D(e){return(await h.default.auth().verifySessionCookie(e||"").catch(()=>({uid:""}))).uid||void 0}async function k(e){return await c.getAsync(e,async()=>await u.get("SELECT * FROM accounts WHERE authID = ?",e))}async function be(){let e=await E.collection("scheduling").get(),t={};e.docs.forEach(a=>{t[a.id]=a.data()}),await B(t)}async function Ie(e,t,a,n){await E.collection("scheduling").add({date:n.getTime(),name:e,args:a,passed:!1}),M(t,a,n)}async function De(e){await E.collection("scheduling").doc(e).set({passed:!0},{merge:!0})}async function $(e,t,a,n,s,o){console.log("hi");let i=await c.getAsync(e,async()=>await u.get("SELECT * FROM products WHERE id = ?",e)),d=await c.getAsync(i.accountID,async()=>await u.get("SELECT * FROM accounts WHERE id = ?",i.accountID));y.sendMail(a.email,"Order Pickup","views/templates/pickup-cus.html",{USER:a.name,EMAIL:d.email,LOCATION:d.location}),y.sendMail(d.email,"Order Pickup","views/templates/pickup-vendor.html",{USER:d.name,CUSTOMER:a.name,ITEM:i.name,QUANT:o,DATE:new Date(s).toDateString()});let p=t/100*parseInt(process.env.PERCENTAGE),l=await b.paymentIntents.create({amount:t,currency:"cad",customer:a.id,payment_method:n,application_fee_amount:p,off_session:!0,confirm:!0,transfer_data:{destination:i.accountID}})}K(De);J("completeOrder",$);r.get("/",async(e,t)=>{let a=await c.getAsync("explore",async()=>await u.all("SELECT id, name, imageURL, price FROM products"));t.render("main/index",{acc:e.cookies.session,products:a})});r.get("/search",async(e,t)=>{let a=await u.all("SELECT id, name, imageURL, price FROM products WHERE name LIKE ? AND category LIKE ?",`%${e.query.query}%`,`%${e.query.category||""}%`);t.render("main/index",{acc:e.cookies.session,products:a})});r.get("/product/:id",async(e,t)=>{let a=await c.getAsync(`fire-${e.params.id}`,async()=>await(await E.collection("products").doc(e.params.id).get()).data(),12096e5),n="";e.cookies.session!==void 0&&(n=await c.getAsync(e.cookies.session,async()=>await D(e.cookies.session),36e5));let s=await c.getAsync(e.params.id,async()=>await u.get("SELECT * FROM products WHERE id = ?",e.params.id)),o=await c.getAsync(s.accountID,async()=>await u.get("SELECT * FROM accounts WHERE id = ?",s.accountID));console.log(n),t.render("product-info/index",{product:s,account:o,dates:a,acc:e.cookies.session,uid:n!=null?n:""})});r.get("/faq",async(e,t)=>{t.render("faq/index",{acc:e.cookies.session,faqs:[{title:"How do I start renting on PartyShare?",text:"You can contact me at janakhosa@gmail.com to get in touch, and we can help you set up your account!"},{title:"What information does PartyShare store about me?",text:"PartyShare only stores your email address and nothing else! This is just to contact you about your order, and give you updates on it."}]})});r.get("/vendor-login",async(e,t)=>{t.render("vendor-login/index",{acc:e.cookies.session})});r.get("/products/create",async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>await D(e.cookies.session),36e5);a===void 0&&t.redirect("/");let n=await k(a);t.render("product/index",{name:n.name})});r.get("/products/edit/:id",async(e,t)=>{let a=await c.getAsync(e.params.id,async()=>await u.get("SELECT * FROM products WHERE id = ?",e.params.id)),n=await c.getAsync(a.accountID,async()=>await u.get("SELECT * FROM accounts WHERE id = ?",a.accountID));t.render("product/index",{name:n.name,product:a})});r.get("/checkout",(e,t)=>{try{if(!e.cookies.customerID){t.redirect("/");return}let{secret:a,product:n,info:s}=c.get(`tempcache-${e.cookies.customerID}`,()=>"");if(!n){t.redirect("/");return}t.render("checkout/index",{secret:a,product:n,info:s,acc:e.cookies.session})}catch{t.redirect("/")}});r.get("/accounts/create",async(e,t)=>{let a=y.computeHash(Math.random().toString()).replace("/","|"),n=await b.accounts.create({type:"express",country:"CA",business_type:"individual"}),s=await b.accountLinks.create({account:n.id,refresh_url:`${X}/accounts/create`,return_url:`${X}/accounts/create/${a}`,type:"account_onboarding"});t.cookie("stripeID",n.id),t.redirect(s.url)});r.get("/accounts/create/:hash",async(e,t)=>{t.render("create-account/index")});r.post("/accounts/login",async(e,t)=>{console.log(e.body);let a=e.body.idToken;await Q(a,14,t),t.end(JSON.stringify({status:"success"}))});r.post("/accounts/create",async(e,t)=>{let a=e.body.idToken,n=(await h.default.auth().verifyIdToken(a)).uid;await Q(a,14,t);let s={id:e.cookies.stripeID,name:e.body.name,email:e.body.email,authID:n,location:e.body.location};await u.run("INSERT INTO accounts VALUES (?, ?, ?, ?, ?);",...Object.values(s)),t.clearCookie("stripeID"),t.end(JSON.stringify({status:"completed"}))});r.post("/products/create",G.single("image"),async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>{await D(e.cookies.session)},36e5);a===void 0&&t.redirect("/");let n=await k(a),s=`${y.computeHash(e.file.originalname+Math.random()).replace(/\//g,"|")}.jpeg`,o=await(0,C.default)(e.file.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();await Y.file(s).createWriteStream({metadata:{cacheControl:"no-cache, max-age=0"}}).end(o);let i=y.generateUID();await u.run("INSERT INTO products VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",e.body["desktop-name"]||e.body["mobile-name"],i,n.id,s,e.body.category,e.body.desc,e.body.info,parseInt(e.body.quantity),parseInt(e.body.price.substring(1))*100),c.del("explore"),await E.collection("products").doc(i).set({"1263310860":1}),c.set(`fire-${i}`,{"1263310860":1}),t.json({status:"200 OK",message:"Product successfully added."})});r.post("/products/edit/:id",G.single("image"),async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>{await D(e.cookies.session)},36e5);a===void 0&&t.redirect("/"),console.log(e.body);let n=await k(a),s=await c.getAsync(e.params.id,async()=>await u.get("SELECT * FROM products WHERE id = ?",e.params.id)),o=s.imageURL;if(e.file){console.log("updated image",o,s.imageURL);let i=await(0,C.default)(e.file.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();await Y.file(o).createWriteStream({metadata:{cacheControl:"no-cache, max-age=0"}}).end(i)}await u.run("UPDATE products SET name = ?, category = ?, desc = ?, info = ?, quantity = ?, price = ? WHERE id = ?",e.body["desktop-name"]||e.body["mobile-name"],e.body.category,e.body.desc,e.body.info,parseInt(e.body.quantity),parseInt(e.body.price.substring(1))*100,e.params.id),c.del("explore"),c.del(e.params.id),t.json({status:"200 OK",message:"Product successfully updated."})});r.post("/orders/create",async(e,t)=>{let a=e.cookies.customerID,s=(await b.paymentMethods.list({customer:a,type:"card"})).data[0].id,{secret:o,product:i,info:d}=c.get(`tempcache-${a}`,()=>"");c.del(`tempcache-${a}`);let p=await c.getAsync(i.accountID,async()=>await u.get("SELECT * FROM accounts WHERE id = ?",i.accountID)),l=await c.getAsync(`fire-${i.id}`,async()=>await(await E.collection("products").doc(i.id).get()).data());console.log(l);let f=O(l,d.startDate,d.endDate,d.quantity,i.quantity);console.log(O),await E.collection("products").doc(i.id).set(f,{merge:!0}),c.del(`fire-${i.id}`),c.del(`tempcache-${a}`),y.sendMail(e.body.email,"Order Confirmation","views/templates/location.html",{USER:e.body.name,EMAIL:p.email,DATE:new Date(d.startDate).toDateString(),ADDRESS:p.location}),y.sendMail(p.email,"New Order","views/templates/order.html",{USER:p.name,EMAIL:e.body.email,ITEM:i.name,QUANT:d.quantity,DATE:new Date(d.startDate).toDateString(),DATE2:new Date(d.endDate).toDateString()});let F=i.price*d.quantity*d.daysRented;Ie("completeOrder",$,[i.id,F,{id:a,name:e.body.name,email:e.body.email,quantity:d.quantity},s,d.endDate],new Date(1640286605e3))});r.post("/checkout",async(e,t)=>{let a=await b.customers.create(),n=await b.setupIntents.create({customer:a.id}),s=c.set(a.id,{name:"",id:a.id,email:""},18e6);t.cookie("customerID",a.id);let{startDate:o,endDate:i,quantity:d,productID:p}=e.body,l=Math.max(o-i,1),f=await c.getAsync(p,async()=>await u.get("SELECT * FROM products WHERE id = ?",p)),F=f.price*d*l;c.set(`tempcache-${a.id}`,{secret:n.client_secret,product:f,info:{quantity:d,daysRented:l,startDate:o,endDate:i}},36e5),t.json({status:"200 OK",message:"Checkout page ready."})});r.delete("/products/delete/",async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>await D(e.cookies.session),36e5);if(console.log(a),a===void 0){t.status(403).send("403 Not Allowed");return}let n=await c.getAsync(e.body.id,async()=>await u.get("SELECT * FROM products WHERE id = ?",e.body.id));(await k(a)).id==n.accountID&&await u.run("DELETE FROM products WHERE id = ?",e.body.id),c.del(e.body.id),c.del("explore"),t.json({status:"200 OK",message:"Product successfully deleted."})});r.get("/logout",async(e,t)=>{t.clearCookie("session"),t.redirect("/")});r.listen(80,async()=>{console.log("Server running..."),console.log(""),await be()});
//# sourceMappingURL=index.js.map
