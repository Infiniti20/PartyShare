var S=Object.create;var g=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty;var R=t=>g(t,"__esModule",{value:!0});var P=(t,e,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of B(e))!L.call(t,a)&&a!=="default"&&g(t,a,{get:()=>e[a],enumerable:!(n=D(e,a))||n.enumerable});return t},u=t=>P(R(g(t!=null?S(C(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var T=require("crypto"),U=require("fs"),f={computeHash:function(t){return T.createHash("sha256").update(t).digest("base64")},generateUUID:function(t){return"xxxxxxxx-xxxx-4xxxx-xxx-x".replace(/[xy]/g,function(e){var n=Math.random()*16|0,a=e=="x"?n:n&3|8;return a.toString(16)})},filter:function(t,e,n){if(!e.originalname.match(/\.(jpg|JPG|jpeg|JPEG|png|PNG)$/))return t.fileValidationError="Only image files are allowed",n(new Error("Only image files are allowed"),!1);n(null,!0)},getExt:function(t){var e=t.lastIndexOf(".");return e<0?"":t.substr(e)},replaceValues:function(t,e){var t=t.replace(/\[\w*\]/g,function(n,a){return e[n.slice(1,-1)]||n});return t},getFileStream:async function(t){let e=U.createReadStream(t);return await new Promise(function(r,o){e.on("data",d=>r(d.toString())),e.on("error",o)})}};var b=u(require("dotenv"));var p=u(require("sqlite3"));p.default.verbose();var y=class{constructor(e){this._db=new p.default.Database(e),this._db.run("PRAGMA journal_mode = WAL")}run(e,...n){return new Promise((a,r)=>{this._db.run(e,...n,function(o){o?r(o):a(this)})})}get(e,...n){return new Promise((a,r)=>{this._db.get(e,...n,(o,d)=>{o?r(o):a(d)})})}all(e,...n){return new Promise((a,r)=>{this._db.all(e,...n,(o,d)=>{o?r(o):a(d)})})}exec(e,...n){return new Promise((a,r)=>{this._db.exec(e,o=>{o?r(o):a(this)})})}};var x=9e5,m=class{constructor(){this._cache={}}all(){return this._cache}get(e,n,a=x){let r=this._cache[e];return r==null&&(r=n(),this.set(e,r,a)),r}async getAsync(e,n,a=x){let r=this._cache[e];return r==null&&(r=n(),this.set(e,r,a)),r}set(e,n,a){this._cache[e]=n,setTimeout(()=>{this.del(e)},a)}del(e){delete this._cache[e]}flush(){this._cache={}}exists(e){return this._cache[e]!=null}};var l=u(require("express")),E=u(require("cookie-parser")),c=u(require("firebase-admin"));var K="service_account",N="partyshare-47d15",_="e25d712d9968cb22e26c6e479eab353491fd2f44",j=`-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCrEnS10v+DHpno
sbEby4fWlgcjUNFhLkdy+MC/0tEL4lQSIwxVePFWL0ZBpwb+trfnZ7fn2khe9DAx
13bFHVMhKR2Lbgny0e/Ea97NRRmutGdBA33KSKEYjRR4MfGfe3/Cgu6K4dGf8+Lc
sKQ8LByA64UbmnKyDDM2DLG2WtH3+uJ8ALdpDbA2w0NQ3pi3YDdI207EZFJOJVpD
CE/L8qSkqjyP8VWAUstj3H+B2j/Ea5zH8RKtQIzPrwBewdn8PJU1QuKuN700anXh
VqzUJwzEjQamMrx+38h8Q6XBxUw357bUuC389JCiquM0VCnbVfdyEwmD+0eUZ3nl
Ku4MdRRfAgMBAAECggEACCACRw3UcOfSgN4fqVBLYq0RfbiS7pNXdWXMfHqIzzsF
VISG9hrzwMInYMA2xtZAJHolSUUcIYEQ4O0jiPfRlkZGTvRU/fbBSopNCgwkIiC+
CV/JvlfLaZ0ZwckCztj7bRjxjMsY57NFAnJT+pT7GEHCEAOP5augAGCDTZlBVmO8
zjPrHQIBrJDaArbylayhb29XoW25oMsaDGOp1Hlx2Fq3wK7txtgIaD7wSlZtsQB6
FUFB03+kiY9TNTpwp1cbxriTtRgu9RKvyQ0Rvk0TGyUdc0brrHnq2U4ot1VJFj1e
n1WT9iHR4Ovx1qC3Al8MPnBrZ+PraVmN5T0CawdsEQKBgQDipCVTBv0OpkS1E8XI
f+KviQueU893NZUruLJAkHFMJYu6dn//pIxGRw4chVwmWIuS2ZhHsztjW2giznEO
92WE8oFAneb9THQDbVwFfOfuY4GdEULoUrNLhFKK1dfise2GVmp3UgQhENcSwoZR
/Z6s9yaDXNK75taVR055SNObLQKBgQDBO4hhnsduoqeTX52dHn9psnqBfzgbUFHh
fdvTdOqzv++6yaoL22hGQTZMuul0Gg4ryHV9VJZ1L0/1epO/9hxGxom58RJLWCxw
SAuH3ZEjS7KYGZgh+IDDGtcdNhykENLOPEWoG1uukBZerjxa3+eLmvHa8vYMzqiW
MySV4NA1OwKBgQDNJt5uUIYii5jn/DTtL+3HDRuKPr0uYD9eKzqXPOiBj/7yUy+7
/XvIZas9X+4w+7ejvvmb9X6NioEx+ILYlFK9zDH5hrU/lcPyEjzY7t6WqFX8ElLp
L2sCsY1yBO39Uyf5kSGgTopUUAUPAyxI7XWDhdjD0fMjiWm2CKzdFnINJQKBgBL9
r9ywRzd3YvLX/dyYR7tyoBmkEDaXAUUhIn64yexam8wGz+CUcr4c4KJP6GvRt7zT
2cA0lQj1Wm1s26KNJKBMGPMeX0bqZouuePukagRHB0ltkoccLkN+ms+zJsN1J9K/
F7V64trYLGqnwyTHRrFwy/5RzJ7bnLQOWLUmQDBLAoGBALPU5afAQEacP1C8KbVM
J9yDEFpHudwgC8c6MnCK0IIpaS4IA+r8f74q/QswyeANyYX9FggdAp+SM1aDOAcQ
fY0+gOptWoB7NuGfk/rhs6ezo8ivLtXWDKzA44DS0K9NNcf1a+ysP6I0mVws5mA8
QEoYzPmkP+BNjhnXqBg5ykMx
-----END PRIVATE KEY-----
`,G="firebase-adminsdk-dx0dk@partyshare-47d15.iam.gserviceaccount.com",M="115450043492170133553",O="https://accounts.google.com/o/oauth2/auth",V="https://oauth2.googleapis.com/token",H="https://www.googleapis.com/oauth2/v1/certs",Q="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-dx0dk%40partyshare-47d15.iam.gserviceaccount.com",w={type:K,project_id:N,private_key_id:_,private_key:j,client_email:G,client_id:M,auth_uri:O,token_uri:V,auth_provider_x509_cert_url:H,client_x509_cert_url:Q};var A=u(require("stripe"));b.default.config();var v="http://partyshare.ca",h=new y("database/partyshare.db");async function q(){h.exec("CREATE TABLE IF NOT EXISTS accounts ( id varchar(25) PRIMARY KEY, name varchar(100), email varchar(80), authID varchar(28), location varchar(250) ) "),h.exec("CREATE TABLE IF NOT EXISTS products ( name varchar(75), id varchar(25), accountID varchar(25), imageURL varchar(55), category varchar(12), desc varchar(250), info varchar(200), quantity int, price int, deposit int )")}q();var F=new m,s=(0,l.default)();s.use(l.default.json());s.use(l.default.urlencoded({extended:!0}));s.use((0,E.default)());c.default.initializeApp({credential:c.default.credential.cert(w),storageBucket:process.env.BUCKET_URL});var re=c.default.firestore(),k=new A.default(process.env.StripeSK,{apiVersion:"2020-08-27"});s.set("view engine","ejs");s.use("/views",l.default.static("views"));async function I(t,e,n){let a=60*60*24*e*1e3,r=await c.default.auth().createSessionCookie(t,{expiresIn:a}),o={maxAge:a};n.cookie("session",r,o)}async function Y(t){return(await c.default.auth().verifySessionCookie(t||"").catch(()=>null)).uid||null}async function z(t){return F.getAsync(t,async()=>await h.get("SELECT * FROM accounts WHERE AuthId = ?",t))}s.get("/",async(t,e)=>{e.render("homepage/index",{acc:t.cookies.session})});s.get("/faq",async(t,e)=>{e.render("faq/index",{acc:t.cookies.session,faqs:[{title:"How do I start renting on PartyShare?",text:"You can contact me at janakhosa@gmail.com to get in touch, and we can help you set up your account!"},{title:"Will I get my deposit back?",text:"Yes! It does take 5 to 10 business days for it to actually show up in your account, so you may not see it right away."},{title:"What information does PartyShare store about me?",text:"PartyShare only stores your email address and nothing else! This is just to contact you about your order, and give you updates on it."}]})});s.get("/vendor-login",async(t,e)=>{e.render("vendor-login/index",{acc:t.cookies.session})});s.get("/products/create",async(t,e)=>{let n=await Y(t.cookies.session);n==null&&e.redirect("/");let a=await z(n);e.render("add/index",{name:a.name})});s.get("/accounts/create",async(t,e)=>{let n=f.computeHash(Math.random().toString()).replace("/","|"),a=await k.accounts.create({type:"express",country:"CA",business_type:"individual"}),r=await k.accountLinks.create({account:a.id,refresh_url:`${v}/accounts/create`,return_url:`${v}/accounts/create/${n}`,type:"account_onboarding"});e.cookie("stripeID",a.id),e.redirect(r.url)});s.get("/accounts/create/:hash",async(t,e)=>{e.render("create-account/index")});s.post("/accounts/login",async(t,e)=>{let n=t.body.idToken,a=(await c.default.auth().verifyIdToken(n)).uid;await I(n,14,e),e.end(JSON.stringify({status:"success"}))});s.post("/accounts/create",async(t,e)=>{let n=t.body.idToken,a=(await c.default.auth().verifyIdToken(n)).uid;await I(n,14,e);let r={id:t.cookies.stripeID,name:t.body.name,email:t.body.email,authID:a,location:t.body.location};await h.run("INSERT INTO accounts VALUES (?, ?, ?, ?, ?);",...Object.values(r)),e.clearCookie("stripeID"),e.end(JSON.stringify({status:"completed"}))});s.get("/logout",async(t,e)=>{e.clearCookie("session"),e.redirect("/")});s.listen(80,()=>{console.log("Server running..."),console.log("")});
//# sourceMappingURL=index.js.map
