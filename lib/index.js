var ee=Object.create;var M=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ie=e=>M(e,"__esModule",{value:!0});var oe=(e,t,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ae(t))!se.call(e,n)&&n!=="default"&&M(e,n,{get:()=>t[n],enumerable:!(a=te(t,n))||a.enumerable});return e},p=e=>oe(ie(M(e!=null?ee(ne(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var N=p(require("crypto")),B=p(require("fs")),W=p(require("nodemailer")),J=p(require("dotenv"));J.default.config();var ce=W.default.createTransport({service:"gmail",auth:{user:process.env.EMAIL,pass:process.env.PASSWORD}}),f={computeHash:function(e){return N.default.createHash("sha256").update(e).digest("base64")},generateUID:function(e){return"xxxxxxxx-xxxx-4xxxx-xxx-x".replace(/[xy]/g,function(t){var a=Math.random()*16|0,n=t=="x"?a:a&3|8;return n.toString(16)})},filter:function(e,t,a){if(!t.originalname.match(/\.(jpg|JPG|jpeg|JPEG|png|PNG|jfif|JFIF|webm|WEBM)$/))return e.fileValidationError="Only image files are allowed",a(new Error("Only image files are allowed"),!1);a(null,!0)},getExt:function(e){var t=e.lastIndexOf(".");return t<0?"":e.substr(t)},replaceValues:function(e,t){var e=e.replace(/\[\w*\]/g,function(a,n){return t[a.slice(1,-1)]||a});return e},getFileStream:async function(e){let t=B.default.createReadStream(e);return await new Promise(function(s,i){t.on("data",o=>s(o.toString())),t.on("error",i)})},sendMail:async function(e,t,a,n){let s=await this.getFileStream(a),i={from:process.env.EMAIL,to:e,subject:t,html:this.replaceValues(s,n)};ce.sendMail(i,function(o,r){o&&console.log(o)})}};var V=p(require("dotenv"));var v=p(require("sqlite3"));v.default.verbose();var C=class{constructor(t){this._db=new v.default.Database(t),this._db.run("PRAGMA journal_mode = WAL")}run(t,...a){return new Promise((n,s)=>{this._db.run(t,...a,function(i){i?s(i):n(this)})})}get(t,...a){return new Promise((n,s)=>{this._db.get(t,...a,(i,o)=>{i?s(i):n(o)})})}all(t,...a){return new Promise((n,s)=>{this._db.all(t,...a,(i,o)=>{i?s(i):n(o)})})}exec(t,...a){return new Promise((n,s)=>{this._db.exec(t,i=>{i?s(i):n(this)})})}};var O=9e5,F=class{constructor(){this._cache={}}all(){return this._cache}get(t,a,n=O){let s=this._cache[t];return s===void 0&&(s=a(),this.set(t,s,n)),s}async getAsync(t,a,n=O){let s=this._cache[t];return s===void 0&&(s=a(),this.set(t,s,n)),s}set(t,a,n=O){this._cache[t]=a,setTimeout(()=>{this.del(t)},n)}del(t){delete this._cache[t]}flush(){this._cache={}}exists(t){return this._cache[t]!==void 0}};var D=p(require("express")),Q=p(require("cookie-parser")),b=p(require("firebase-admin"));var re="service_account",ue="partyshare-2e5c5",de="55add276a4ca1aa083b47471cb9d3087ae1309c3",me=`-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDWTy098vBTy6fd
60zlLdGzhNSO0jvM3JcYmruoN7ywjeuHeuV30nUPkpkrVQ64o3nJ+hKNUgiRiJyu
X/TP4xGMRavIvJFtyrbcKdpRM4m8ScvWC4K7LNxJslea8rHdkUun9RKPdMfRrpZl
j0PIo+Ws6/YxQ7QOlNW6sVe+Y+40dN7gdBP2mIZ8hVM9r4TJAUI5K3C7/BP8Npem
WPXyaxkf/oqzxK3Js/IZM4wIcweRjzMwFHGywpGJTvx+VyQJ6K+SM8zBh4GS3z7L
jvVk6G7b1+2rfWtx1wrWJP/F+tdZ9Ppkuehl8fCD4I8n8uLf54n8SNoM0nhhfl0P
8q7lH/wpAgMBAAECggEAVH6tGMKi7HbcPYvbKnSxPDU/1PugpjnGvOWs3Tr0gyvB
VA4pUN/CVZx4FXSYtEWH7BFTpTJVvIN/OuUMUbZ2IbcKbr+iGwaUqCM8N025nWn/
Guo45fFe/RN6pNXROMljadofMj5Z1hseovYkRIQSNuZlj7Dg2ermhZAMRz2BGl7N
F/4PqDvFbSbWM89/JR0PBNAkJeJ0EEvgpTOuqDuvPnfaHXWLlgDs7gyDdwEBY1lR
cGqZ61vM8cgh1+M0lUz9M9DHxAFfCZEsndlJDrc9GqRIf/xjq4feKyFHnvLOgOgi
YihOb/Ncus4jmEhZs+1dzsCbcPgDJjrTFlOnFgZH7QKBgQDsTKAfG/lmMWmuldiZ
VJgNMa017r/0hETlBe6kjgJwPYlNfTAijqmUuK6k4oMw/jkV16Xneex0gCxP7KpF
i6JsNcqb5EfDdls7drbV5DH30YOXfiFyFzEvwl7TBUaZn0Sg+8hS3hizS2Xvw9wH
seb69re9GdhraNHTpFWUS5iT7wKBgQDoLTbi6JjJ6R7CstwSdFwCUGQTA03Wirgs
5PPBmHWft/lANkvaIOjJ9CBtA2UHuSBjafe5zuNoAolKMn5PIGzHTRgVEOAqHRun
y7cm3TJFXYTXpVIHwqlTjXGYz8dv+RmN3gYTq6LwdKN/PKhv6xYSDByRtpiPRcEu
Tziq3bf5ZwKBgA8zfrmBmzGvzBSnHx/+CSoQIAxwJ3kbaTMyhn+fgxilXMfXXdlb
RB2FI/cHe1kTgaieDtYtScDU3gTmPK3spa5AZ6BPty4j1wqkQG7SF0TR/Z0pSA2G
4GsqHd+FX11SmZ+hkumB0CT4nL4n42e7Uhii9n77wqhmPdlXoQnBMzeRAoGBAJzD
ep224wLhjk1zqrgjLMS7NvbHclT7kONvK055/GF9PKQohQqg0c0aMpKoihyu2LmH
ISaqFE1z+PLKKRKQGCJxYWNH47NLuBKRr/Zjv7+qJznbfAmVW/L4O80r7cMi9Cgf
0waRCxFED+inMitvFZXV66xPF68VMBxujRqBXejdAoGAHubOBTHI3MwkZJkZntNu
wAqmQ33YhcrBJwsrTJR2zUAeIWRh4hnD8uhzX7kCbC6cxw/zXgk8e9lIrTwvSwFS
XCb6u/5+kGVHxdRK0MVqj9Xzr5LsYycQ9LW7zu0EWsPHHn0vrDCWCr8BrmfklNEC
uQojKxH5xNf7q0FTr2sM3nM=
-----END PRIVATE KEY-----
`,le="firebase-adminsdk-77bd3@partyshare-2e5c5.iam.gserviceaccount.com",ge="113520744972971826056",pe="https://accounts.google.com/o/oauth2/auth",ye="https://oauth2.googleapis.com/token",fe="https://www.googleapis.com/oauth2/v1/certs",he="https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-77bd3%40partyshare-2e5c5.iam.gserviceaccount.com",_={type:re,project_id:ue,private_key_id:de,private_key:me,client_email:le,client_id:ge,auth_uri:pe,token_uri:ye,auth_provider_x509_cert_url:fe,client_x509_cert_url:he};var Y=p(require("stripe")),A=p(require("sharp")),H=p(require("multer"));var I=864e5;function be(e,t){let a=[],n=e;if(t===e)return[e];for(t-=I;n!==t;)n+=I,a.push(n);return[e,...a,t+=I]}function j(e,t,a,n,s){let r=Object.keys(e).filter(u=>parseInt(u)>=t&&parseInt(u)<=a).map(u=>e[u.toString()]),l=be(t,a);if(r.some(u=>u-n>0)||r.length<1){for(let g of l)e[g]?e[g]-=n:e[g]=s-n;let u=a+I;return e[u]?e[u]+=n:e[u]=s,e}}var $=p(require("source-map-support"));var K=p(require("long-timeout")),x={};function U(e,t){return x[e]=t,t}function G(e){return x.edit=e,e}function L(e,t,a){let n=we(a);K.default.setTimeout(()=>{console.log("executed"),e(...t)},n)}function we(e){let t=e.getTime(),a=new Date().getTime();return Math.max(t-a,0)}async function z(e){let t=new Date().getTime(),a=Object.keys(e),n=Object.values(e);for(let s=0;s<n.length;s++){let i=n[s];if(t>i.date){i.passed==!1&&(x[i.name](...i.args),await x.edit(a[s]));continue}L(x[i.name],i.args,new Date(i.date))}}V.default.config();var P=process.env.BASE_URL,m=new C("database/partyshare.db"),c=new F,d=(0,D.default)();d.use(D.default.json());d.use(D.default.urlencoded({extended:!0}));d.use((0,Q.default)());d.set("view engine","ejs");d.use("/views",D.default.static("views"));b.default.initializeApp({credential:b.default.credential.cert(_),storageBucket:process.env.BUCKET_URL});var w=b.default.firestore(),S=b.default.storage().bucket(),E=new Y.default(process.env.STRIPE_KEY,{apiVersion:"2020-08-27"}),Z=(0,H.default)({storage:H.default.memoryStorage(),fileFilter:f.filter});$.default.install();async function X(e,t,a){let n=60*60*24*t*1e3,s=await b.default.auth().createSessionCookie(e,{expiresIn:n}),i={maxAge:n};a.cookie("session",s,i)}async function R(e){return(await b.default.auth().verifySessionCookie(e||"").catch(()=>({uid:""}))).uid||void 0}async function T(e){return await c.getAsync(e,async()=>await m.get("SELECT * FROM accounts WHERE authID = ?",e))}async function Ee(){let e=await w.collection("scheduling").get(),t={};e.docs.forEach(a=>{t[a.id]=a.data()}),await z(t)}async function xe(e,t,a,n){await w.collection("scheduling").add({date:n.getTime(),name:e,args:a,passed:!1}),L(t,a,n)}async function De(e){await w.collection("scheduling").doc(e).set({passed:!0},{merge:!0})}async function q(e,t,a,n,s,i){let o=await c.getAsync(e,async()=>await m.get("SELECT * FROM products WHERE id = ?",e)),r=await c.getAsync(o.accountID,async()=>await m.get("SELECT * FROM accounts WHERE id = ?",o.accountID));f.sendMail(a.email,"Order Pickup","views/templates/pickup-cus.html",{USER:a.name,EMAIL:r.email,LOCATION:r.location}),f.sendMail(r.email,"Order Pickup","views/templates/pickup-vendor.html",{USER:r.name,CUSTOMER:a.name,ITEM:o.name,QUANTITY:i,DATE:new Date(s).toDateString()});let l=t/100*parseInt(process.env.PERCENTAGE),u=await E.paymentIntents.create({amount:t,currency:"cad",customer:a.id,payment_method:n,application_fee_amount:l,off_session:!0,confirm:!0,transfer_data:{destination:o.accountID}})}G(De);U("completeOrder",q);d.get("/",async(e,t)=>{let a=await c.getAsync("explore",async()=>await m.all("SELECT id, name, imageURL, price FROM products"));t.render("main/index",{acc:e.cookies.session,products:a})});d.get("/search",async(e,t)=>{let a=await m.all("SELECT id, name, imageURL, price FROM products WHERE name LIKE ? AND category LIKE ?",`%${e.query.query}%`,`%${e.query.category||""}%`);t.render("main/index",{acc:e.cookies.session,products:a})});d.get("/product/:id",async(e,t)=>{let a=await c.getAsync(`fire-${e.params.id}`,async()=>await(await w.collection("products").doc(e.params.id).get()).data(),12096e5),n="";e.cookies.session!==void 0&&(n=await c.getAsync(e.cookies.session,async()=>await R(e.cookies.session),36e5));let s=await c.getAsync(e.params.id,async()=>await m.get("SELECT * FROM products WHERE id = ?",e.params.id)),i=await c.getAsync(s.accountID,async()=>await m.get("SELECT * FROM accounts WHERE id = ?",s.accountID)),o=await c.getAsync(`subimages-${s.id}`,async()=>await m.all("SELECT * FROM subimages WHERE productId = ?",s.id));console.log(o),t.render("product-info/index",{product:s,account:i,dates:a,acc:e.cookies.session,uid:n!=null?n:"",subimages:o})});d.get("/faq",async(e,t)=>{t.render("faq/index",{acc:e.cookies.session,faqs:[{title:"How do I start renting on PartyShare?",text:"You can contact me at janakhosa@gmail.com to get in touch, and we can help you set up your account!"},{title:"What information does PartyShare store about me?",text:"PartyShare only stores your email address and nothing else! This is just to contact you about your order, and give you updates on it."}]})});d.get("/about-us",async(e,t)=>{t.render("about-us/index")});d.get("/contact",async(e,t)=>{t.render("embed/index",{content:'<p>You can contact me <a href="mailto:janakhosa@gmail.com">here</a> for any special inquiries.</p>'})});d.get("/vendor-login",async(e,t)=>{t.render("vendor-login/index",{acc:e.cookies.session})});d.get("/products/create",async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>await R(e.cookies.session),36e5);a===void 0&&t.redirect("/");let n=await T(a);t.render("product/index",{name:n.name})});d.get("/products/edit/:id",async(e,t)=>{let a=await c.getAsync(e.params.id,async()=>await m.get("SELECT * FROM products WHERE id = ?",e.params.id)),n=await c.getAsync(a.accountID,async()=>await m.get("SELECT * FROM accounts WHERE id = ?",a.accountID)),s=await c.getAsync(`subimages-${a.id}`,async()=>await m.all("SELECT * FROM subimages WHERE productId = ?",a.id));t.render("product/index",{name:n.name,product:a,subimages:s})});d.get("/checkout",(e,t)=>{try{if(!e.cookies.customerID){t.redirect("/");return}let{secret:a,product:n,info:s}=c.get(`tempcache-${e.cookies.customerID}`,()=>"");if(!n){t.redirect("/");return}t.render("checkout/index",{secret:a,product:n,info:s,acc:e.cookies.session})}catch{t.redirect("/")}});d.get("/accounts/create",async(e,t)=>{let a=f.computeHash(Math.random().toString()).replace("/","|"),n=await E.accounts.create({type:"express",country:"CA",business_type:"individual"});console.log(`${P}/accounts/create`);let s=await E.accountLinks.create({account:n.id,refresh_url:`${P}/accounts/create/`,return_url:`${P}/accounts/create/${a}/`,type:"account_onboarding"});t.cookie("stripeID",n.id),t.redirect(s.url)});d.get("/accounts/create/:hash",async(e,t)=>{t.render("create-account/index")});d.post("/accounts/login",async(e,t)=>{console.log(e.body);let a=e.body.idToken;await X(a,14,t),t.end(JSON.stringify({status:"success"}))});d.post("/accounts/create",async(e,t)=>{let a=e.body.idToken,n=(await b.default.auth().verifyIdToken(a)).uid;await X(a,14,t);let s={id:e.cookies.stripeID,name:e.body.name,email:e.body.email,authID:n,location:e.body.location};await m.run("INSERT INTO accounts VALUES (?, ?, ?, ?, ?);",...Object.values(s)),t.clearCookie("stripeID"),t.end(JSON.stringify({status:"completed"}))});d.post("/products/create",Z.fields([{name:"image",maxCount:1},{name:"sub-image-1",maxCount:1},{name:"sub-image-2",maxCount:1},{name:"sub-image-3",maxCount:1}]),async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>{await R(e.cookies.session)},36e5);a===void 0&&t.redirect("/");let n=await T(a),s=e.files,i=s.image[0],o=`${f.computeHash(i.originalname+Math.random()).replace(/\//g,"|")}.jpeg`,r=await(0,A.default)(i.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();await S.file(o).createWriteStream({metadata:{cacheControl:"no-cache, max-age=0"}}).end(r),console.log(e.files);let l=f.generateUID();for(let u=1;u<Object.keys(e.files).length;u++){let g=s[`sub-image-${u}`][0],h=`${f.computeHash(g.originalname+Math.random()).replace(/\//g,"|")}.jpeg`,k=await(0,A.default)(g.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();S.file(h).createWriteStream({metadata:{cacheControl:"no-cache, max-age=0"}}).end(k),await m.run("INSERT INTO subimages VALUES(?,?)",h,l)}await m.run("INSERT INTO products VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?)",e.body["desktop-name"]||e.body["mobile-name"],l,n.id,o,e.body.category,e.body.desc,e.body.info,parseInt(e.body.quantity),parseInt(e.body.price.substring(1))*100),c.del("explore"),await w.collection("products").doc(l).set({"1263310860":1}),c.set(`fire-${l}`,{"1263310860":1}),t.json({status:"200 OK",message:"Product successfully added."})});d.post("/products/edit/:id",Z.fields([{name:"image",maxCount:1},{name:"sub-image-1",maxCount:1},{name:"sub-image-2",maxCount:1},{name:"sub-image-3",maxCount:1}]),async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>{await R(e.cookies.session)},36e5);if(a===void 0){t.redirect("/");return}let n=await c.getAsync(e.params.id,async()=>await m.get("SELECT * FROM products WHERE id = ?",e.params.id));if((await T(a)).id!=n.accountID){t.redirect("/");return}let i=e.files,o=n.imageURL;if(i.image){let u=i.image[0];console.log("updated image",o,n.imageURL);let g=await(0,A.default)(u.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();await S.file(o).createWriteStream({metadata:{cacheControl:"no-cache, max-age=0"}}).end(g)}let r=await c.getAsync(`subimages-${n.id}`,async()=>await m.all("SELECT * FROM subimages WHERE productId = ?",n.id)),l=Object.keys(e.files);for(let u=0;u<Object.keys(e.files).length&&l[u]!="image";u++){let g=parseInt(l[u].split("-")[2]),h=i[`sub-image-${g}`][0],k=await(0,A.default)(h.buffer).resize({width:350,height:350}).jpeg({quality:70}).toBuffer();S.file(r[g-1].imageURL).createWriteStream({metadata:{cacheControl:"no-cache, max-age=0"}}).end(k)}await m.run("UPDATE products SET name = ?, category = ?, desc = ?, info = ?, quantity = ?, price = ? WHERE id = ?",e.body["desktop-name"]||e.body["mobile-name"],e.body.category,e.body.desc,e.body.info,parseInt(e.body.quantity),parseInt(e.body.price.substring(1))*100,e.params.id),c.del("explore"),c.del(e.params.id),t.json({status:"200 OK",message:"Product successfully updated."})});d.post("/orders/create",async(e,t)=>{let a=e.cookies.customerID,s=(await E.paymentMethods.list({customer:a,type:"card"})).data[0].id,{secret:i,product:o,info:r}=c.get(`tempcache-${a}`,()=>"");c.del(`tempcache-${a}`);let l=await c.getAsync(o.accountID,async()=>await m.get("SELECT * FROM accounts WHERE id = ?",o.accountID)),u=await c.getAsync(`fire-${o.id}`,async()=>await(await w.collection("products").doc(o.id).get()).data());console.log(u);let g=j(u,r.startDate,r.endDate,r.quantity,o.quantity);console.log(j),await w.collection("products").doc(o.id).set(g,{merge:!0}),c.del(`fire-${o.id}`),c.del(`tempcache-${a}`),f.sendMail(e.body.email,"Order Confirmation","views/templates/location.html",{USER:e.body.name,EMAIL:l.email,DATE:new Date(r.startDate).toDateString(),ADDRESS:l.location}),f.sendMail(l.email,"New Order","views/templates/order.html",{USER:l.name,EMAIL:e.body.email,ITEM:o.name,QUANT:r.quantity,DATE:new Date(r.startDate).toDateString(),DATE2:new Date(r.endDate).toDateString()});let h=o.price*r.quantity*r.daysRented;console.log(r,[o.id,h,{id:a,name:e.body.name,email:e.body.email,quantity:r.quantity},s,r.endDate]),xe("completeOrder",q,[o.id,h,{id:a,name:e.body.name,email:e.body.email},s,r.endDate,r.quantity],new Date(r.startDate))});d.post("/checkout",async(e,t)=>{let a=await E.customers.create(),n=await E.setupIntents.create({customer:a.id}),s=c.set(a.id,{name:"",id:a.id,email:""},18e6);t.cookie("customerID",a.id);let{startDate:i,endDate:o,quantity:r,productID:l}=e.body,u=Math.max((o-i)/864e5,1),g=await c.getAsync(l,async()=>await m.get("SELECT * FROM products WHERE id = ?",l)),h=g.price*r*u;c.set(`tempcache-${a.id}`,{secret:n.client_secret,product:g,info:{quantity:r,daysRented:u,startDate:i,endDate:o}},36e5),t.json({status:"200 OK",message:"Checkout page ready."})});d.delete("/products/delete/",async(e,t)=>{let a=await c.getAsync(e.cookies.session,async()=>await R(e.cookies.session),36e5);if(console.log(a),a===void 0){t.status(403).send("403 Not Allowed");return}let n=await c.getAsync(e.body.id,async()=>await m.get("SELECT * FROM products WHERE id = ?",e.body.id));(await T(a)).id==n.accountID&&await m.run("DELETE FROM products WHERE id = ?",e.body.id),c.del(e.body.id),c.del("explore"),t.json({status:"200 OK",message:"Product successfully deleted."})});d.get("/logout",async(e,t)=>{t.clearCookie("session"),t.redirect("/")});d.listen(3e3,async()=>{console.log("Server running..."),console.log(""),await Ee()});
//! * POST REQUESTS
//# sourceMappingURL=index.js.map
